function e(e,t,i,n,a,s,r){try{var l=e[s](r),o=l.value}catch(e){i(e);return}l.done?t(o):Promise.resolve(o).then(n,a)}function t(t){return function(){var i=this,n=arguments;return new Promise(function(a,s){var r=t.apply(i,n);function l(t){e(r,a,s,l,o,"next",t)}function o(t){e(r,a,s,l,o,"throw",t)}l(void 0)})}}class i{_loadDebugger(){var e=this;return t(function*(){if(!e._log){let{default:t}=yield import("./isDebug.js");e._log=t}})()}static _checkDevice(e){let t=navigator.userAgent.toLowerCase(),i={CHROME:()=>t.includes("chrome")&&"chrome"in window&&!t.includes("edg"),SAFARI:()=>/^((?!chrome|android).)*safari/i.test(t),FIREFOX:()=>t.includes("firefox"),EDGE:()=>t.includes("chrome")&&t.includes("edg"),IE:()=>/msie|trident/.test(t),TOUCH:()=>"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,MOBILE:()=>/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),PC:()=>!/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),MOBILE_SAFARI:()=>/iphone|ipad|ipod/i.test(t)&&/^((?!chrome|android).)*safari/i.test(t)};return(null!=e?e:[]).some(e=>{var t;return null==i?void 0:null==(t=i[e])?void 0:t.call(i)})}static _checkConnection(e){var t,i;let n=null==(i=navigator)?void 0:null==(t=i.connection)?void 0:t.downlink;return n&&n<1.2||e>600}static _checkFallback(e,{mediaQuery:t,isBuilder:n,whenDisabled:a}){let s=[!!a.includes("SLOW_CONNECTION")&&i._checkConnection(e),!window.matchMedia(t).matches,i._checkDevice(a)];return{enableFallback:!n&&s.some(Boolean),potentialReasons:s}}_setCanvas(e,t){if(!(t&&"string"==typeof t))return this._log&&this._log({id:e,err:1}),!1;let i=document.querySelector(t);if(!i)return!1;if("CANVAS"===i.nodeName&&"function"==typeof i.getContext)return i.dataset.sequenceId=e,i;let n=i.querySelector("canvas");return n&&"mp-sequence"===i.nodeName.toLowerCase()?(i.dataset.sequenceId=e,n):(this._log&&this._log({id:e,err:2}),!1)}constructor(){if(this._log=null,this.constructor===i)throw Error("Cannot create an instance of ISBase")}}i.transpExt=["png","webp","avif"];export class ImageSequence extends i{get currentNode(){return ImageSequence.canvasInstances[this.canvasSelector].currentNode}set currentNode(e){ImageSequence.canvasInstances[this.canvasSelector]&&(ImageSequence.canvasInstances[this.canvasSelector].currentNode=e)}_init(){var e=this;return t(function*(){if(!e.id||!e.canvasSelector||!e.largeImagesRoot||!e.totalFrames)return;e.isDebug&&(yield e._loadDebugger());let t=e._setCanvas(e.id,e.canvasSelector);if(!t)return;let i=performance.now(),{enableFallback:n,potentialReasons:a}=ImageSequence._checkFallback(performance.now()-i,{mediaQuery:e.mediaQuery,isBuilder:e._isBuilder,whenDisabled:e.whenDisabled});n&&5===e.fallbackMode||(e.enableFallback=n,e.potentialReasons=a,e._canvas=t,e._handleInstances())})()}_handleInstances(){let{canvasSelector:e,id:t}=this,i=ImageSequence.canvasInstances[e];i&&ImageSequence.canvasInstances[e].index++,e&&(i||(ImageSequence.canvasInstances[e]={index:1,currentNode:t}),this._canvasIndex=ImageSequence.canvasInstances[e].index),this._setup()}_setup(){var e=this;return t(function*(){var t,i,n,a,s,r;let{smallImagesRoot:l,mediumImagesRoot:o,frames:c}=e,h=e._canvas;e.totalFrames=c[1]-c[0]+1,e.startAt=e.isReverse?e.frames[1]:e.frames[0],l&&innerWidth<(null!=(s=null==(i=window.MOTIONPAGE_FRONT)?void 0:null==(t=i.bp)?void 0:t.s)?s:768)?e._basePath=l:o&&innerWidth<(null!=(r=null==(a=window.MOTIONPAGE_FRONT)?void 0:null==(n=a.bp)?void 0:n.m)?r:1024)?e._basePath=o:e._basePath=e.largeImagesRoot;let d=ImageSequence.transpExt.includes(e.ext)||"contain"===e.scaleMode;if(e._ctx=h.getContext("2d",{alpha:d,willReadFrequently:!0}),!e._ctx){"function"==typeof h.remove&&h.remove(),e._log&&e._log({id:e.id,err:5});return}e._resizeController=new AbortController,ImageSequence.resizeControllers.push(e._resizeController),e._handleResize=e._handleResize.bind(e),addEventListener("resize",e._handleResize,{signal:e._resizeController.signal}),e._basePath&&e._loadFirstFrame()})()}_loadFirstFrame(){let e=this.numPadding?String(this.startAt).padStart(this.numPadding,"0"):String(this.startAt);if("0000"!==e){if(this.enableFallback){this._handleFallback(this.potentialReasons);return}this._handleResize(),window.MOTIONPAGE_FRONT.isw.loadImage({src:`${this._basePath}${e}.${this.ext}`,origin:document.location.origin}).then(e=>{1===this._canvasIndex&&e&&requestAnimationFrame(()=>this._canvasDraw(e,this.startAt-this.startAt)),this._loadImages()}).catch(()=>{this._log&&this._log({id:this.id,err:3})})}}_loadImages(){var e=this;return t(function*(){let{totalFrames:t,frames:i}=e;if(!t||i[1]<i[0]){e._log&&e._log({id:e.id,err:7});return}let{priorityQueue:n,queue:a}=e._createQueue(),s=performance.now();if(yield e._loadPriorityQueue(n,s),null==a?void 0:a.length){if(e._loadQueue=e._loadQueue.bind(e),e.isInternObserv&&"IntersectionObserver"in window&&!e._isBuilder){e._handleInterObserve(()=>e._loadQueue(a));return}e._loadQueue(a)}})()}_createQueue(){let{totalFrames:e,skipFrames:t}=this,i=Array.from({length:this.totalFrames},(e,t)=>t+this.startAt);t&&(i=i.filter((e,i)=>i%t!=0));let n=i.slice(0,Math.floor(.25*i.length)),a=n.map((t,a)=>{let s=Math.floor(a/n.length*e);return i.reduce((e,t)=>Math.abs(t-s)<Math.abs(e-s)?t:e)}),s=i.filter(e=>!a.includes(e));return(null==s?void 0:s.length)&&!(null==a?void 0:a.length)&&(a=s,s=[]),{priorityQueue:a,queue:s}}_loadImage(e){var i=this;return t(function*(){if(0===e)return null;let t=String(e).padStart(i.numPadding,"0");return window.MOTIONPAGE_FRONT.isw.loadImage({src:`${i._basePath}${t}.${i.ext}`,origin:document.location.origin}).then(e=>e).catch(()=>null)})()}_loadPriorityQueue(e,i){var n=this;return t(function*(){for(let t of e)yield n._loadImage(t);if(n._log){let t=((performance.now()-i)/1e3).toFixed(3);n._log({id:n.id,err:8},null==e?void 0:e.length,t)}})()}_loadQueue(e){let t=performance.now();for(let t of e)this._loadImage(t);let i=((performance.now()-t)/1e3).toFixed(3);this._log&&this._log({id:this.id,err:9},null==e?void 0:e.length,i)}_handleInterObserve(e){let t=new IntersectionObserver(i=>{i.length>0&&i[0].isIntersecting&&(t.disconnect(),e())},{rootMargin:`${this.ioMargin}%`});t.observe(this._canvas)}_handleResize(){let e=this._canvas;if(1===this._canvasIndex){var t,i;let n=1.25*window.devicePixelRatio,a=null!=(t=e.offsetWidth)?t:e.width,s=null!=(i=e.offsetHeight)?i:e.height;e.width=a*n,e.height=s*n}this._imgIdxInCanvas&&this.id===this.currentNode&&this._loadImage(this._imgIdxInCanvas).then(e=>{e&&requestAnimationFrame(()=>this._canvasDraw(e,this._imgIdxInCanvas))})}_handleFallback(e){let{fallbackMode:t}=this;if(5!==t){if([0,1,4].includes(t)){let e=this.startAt-this.startAt;if(e=0===e?e+1:e,4===t){var i,n;e=null!=(n=null!=(i=this.totalFrames)?i:this.frames[1])?n:1}this._loadImage(e).then(i=>{i?this._canvasDraw(i,e,1!==t):this._canvas&&"function"==typeof this._canvas.remove&&this._canvas.remove()})}2===t&&this._canvas&&"function"==typeof this._canvas.remove&&this._canvas.remove(),1!==t&&this._resizeController&&this._resizeController.abort(),this._preventUpdate=!0,this._log&&this._log({id:this.id,err:6},t,e.indexOf(!0))}}handleUpdate(e){if(this._preventUpdate||this._lock)return;let t=Math.floor((this.isReverse?1-e:e)*this.totalFrames);this._loadImage(t).then(e=>{e&&requestAnimationFrame(()=>this._canvasDraw(e,t))})}reset(){this._lock=!0,this._resizeController&&(removeEventListener("resize",this._handleResize),this._resizeController.abort(),this._resizeController=null),ImageSequence.resizeControllers=ImageSequence.resizeControllers.filter(e=>e!==this._resizeController),setTimeout(()=>{this._lock=!1,this._init()},100)}_canvasDraw(e,t,i=!1){let n,a;if(!e)return;let s=this._canvas;if(!s)return;let r=this._ctx,l=s.width,o=s.height,c=l/o,h=e.width/e.height,d=null,u=null;if("cover"===this.scaleMode?(c>h?a=(n=l)/h:n=(a=o)*h,d=l/2-n/2,u=o/2-a/2):"contain"===this.scaleMode?c<h?a=(n=l)/h:n=(a=o)*h:(n=e.width,a=e.height),d=null===d?l/2-n/2:d,u=null===u?o/2-a/2:u,r.save(),(this._isBuilder||ImageSequence.transpExt.includes(this.ext)||"contain"===this.scaleMode)&&(r.clearRect(0,0,l,o),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,l,o)),r.drawImage(e,0,0,e.width,e.height,~~d,~~u,~~n,~~a),r.restore(),i){s.toBlob(e=>{if(!e)return;let t=new Image;t.onload=()=>{var e;t.style.objectFit=this.scaleMode,null==(e=s.parentNode)||e.replaceChild(t,s),URL.revokeObjectURL(t.src)},t.onerror=()=>{console.error("Error while replacing canvas with image")},t.src=URL.createObjectURL(e)});return}this._imgIdxInCanvas=t,this.currentNode=this.id}constructor(e){var t,i,n,a,s,r,l,o,c,h,d,u,m,_,g,v,f,I,b;super(),this._isBuilder=!!(null==(i=window)?void 0:null==(t=i.top)?void 0:t.motionpage),this._canvas=null,this._ctx=null,this._canvasIndex=0,this._imgIdxInCanvas=0,this._basePath="",this._preventUpdate=!1,this._lock=!1,this._resizeController=null,this.startAt=1,this.scaleMode="cover",this.enableFallback=!1,this.potentialReasons=[],void 0!==e.frames&&Array.isArray(e.frames)||(e.frames=[]),this.id=null!=(n=e.id)?n:"",this.canvasSelector=null!=(a=e.canvasSelector)?a:"",this.largeImagesRoot=null!=(s=e.largeImagesRoot)?s:"",this.mediumImagesRoot=null!=(r=e.mediumImagesRoot)?r:"",this.smallImagesRoot=null!=(l=e.smallImagesRoot)?l:"",this.ext=null!=(o=e.ext)?o:"jpg",this.totalFrames=null!=(c=e.totalFrames)?c:0,this.numPadding=null!=(h=e.numPadding)?h:4,this.skipFrames=null!=(d=e.skipFrames)?d:0,this.frames=2===e.frames.length?e.frames:[1,this.totalFrames],this.isDebug=null!=(u=e.isDebug)&&u,this.isReverse=null!=(m=e.isReverse)&&m,this.isInternObserv=null!=(_=e.isIntersectionObserver)&&_,this.ioMargin=null!=(g=e.intersectionObserverMargin)?g:0,this.timelineUID=null!=(v=e.timelineUID)?v:"",this.whenDisabled=null!=(f=e.whenDisabled)?f:[],this.fallbackMode=null!=(I=e.fallbackMode)?I:0,1===e.imageFit?this.scaleMode="contain":2===e.imageFit&&(this.scaleMode="fill"),this.mediaQuery=null!=(b=e.mediaQuery)?b:"screen",this._init()}}ImageSequence.canvasInstances={},ImageSequence.resizeControllers=[],window._mp_ImageSequence=ImageSequence,window.MOTIONPAGE_FRONT.imageSequence=ImageSequence;